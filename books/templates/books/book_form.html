{% extends 'base.html' %}
{% load static %}

{% block title %}{{ action }} Book - Mindfolio{% endblock %}

{% block content %}
<div class="py-10">
    <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
        <div class="mb-6">
            <a href="{% if book %}{% url 'book_detail' book.pk %}{% else %}{% url 'library' %}{% endif %}"
               class="text-sm font-medium text-muted-foreground hover:text-foreground">
                ← Back
            </a>
        </div>

        <div class="p-6 rounded-lg border bg-card text-card-foreground shadow-sm">
            <h1 class="text-2xl font-bold text-foreground mb-6">{{ action }} Book</h1>

            <form method="post" enctype="multipart/form-data" class="space-y-8">
                {% csrf_token %}

                <section class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-foreground">Basics</h2>
                        <p class="text-sm text-muted-foreground">Give Mindfolio the essentials so it can organize the rest.</p>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="{{ form.title.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                Title <span class="text-destructive">*</span>
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <p class="mt-1 text-sm text-destructive">{{ form.title.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="{{ form.author.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                Author <span class="text-destructive">*</span>
                            </label>
                            {{ form.author }}
                            {% if form.author.errors %}
                            <p class="mt-1 text-sm text-destructive">{{ form.author.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <label for="{{ form.publication_year.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                Publication Year
                            </label>
                            {{ form.publication_year }}
                        </div>
                        <div>
                            <label for="{{ form.primary_format.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                Primary Format
                            </label>
                            {{ form.primary_format }}
                        </div>
                    </div>
                </section>

                <hr class="border-border">

                <section class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-foreground">Reading Journey</h2>
                        <p class="text-sm text-muted-foreground">Track progress, timing, and how the book landed.</p>
                    </div>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                        <div>
                            <label for="{{ form.status.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                Status
                            </label>
                            {{ form.status }}
                        </div>
                        <div>
                            <label for="{{ form.started_at.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                Started Date
                            </label>
                            {{ form.started_at }}
                        </div>
                        <div>
                            <label for="{{ form.finished_at.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                                Finished Date
                            </label>
                            {{ form.finished_at }}
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                            Rating (0.5 - 5.0)
                        </label>
                        <div x-data="{
                                value: '{{ form.overall_rating.value|default:'' }}',
                                numericValue() {
                                    return parseFloat(this.value) || null;
                                },
                                setValue(v) {
                                    this.value = v;
                                    this.$refs.ratingInput.value = v;
                                },
                                clear() {
                                    this.value = '';
                                    this.$refs.ratingInput.value = '';
                                }
                            }">
                            {{ form.overall_rating.as_widget(attrs={'class': 'sr-only', 'type': 'hidden', 'x-ref': 'ratingInput'}) }}
                            <input type="range"
                                   min="0.5"
                                   max="5"
                                   step="0.5"
                                   class="w-full accent-primary"
                                   :value="numericValue() || 0.5"
                                   @input="setValue($event.target.value)"
                                   aria-label="Set rating between 0.5 and 5 stars">
                            <div class="mt-2 flex items-center justify-between text-xs text-muted-foreground">
                                <div class="flex items-center gap-2">
                                    <div class="flex">
                                        <template x-for="star in 5" :key="star">
                                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"
                                                 :class="numericValue() >= star ? 'text-yellow-400' : 'text-border'">
                                                <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                            </svg>
                                        </template>
                                    </div>
                                    <span x-text="numericValue() ? `${numericValue().toFixed(1)} ★` : 'Not rated yet'"></span>
                                </div>
                                <button type="button" class="hover:text-foreground" @click="clear()">Clear</button>
                            </div>
                        </div>
                        {% if form.overall_rating.errors %}
                        <p class="mt-1 text-sm text-destructive">{{ form.overall_rating.errors.0 }}</p>
                        {% endif %}
                    </div>
                </section>

                <hr class="border-border">

                <section class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-foreground">Media & Tags</h2>
                        <p class="text-sm text-muted-foreground">Keep covers, files, and taxonomy tidy.</p>
                    </div>
                    <div>
                        <label for="{{ form.cover_image.id_for_label }}" class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                            Cover Image
                        </label>
                        {% if book and book.cover_image %}
                        <div class="mb-3">
                            <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="h-48 w-auto rounded-lg shadow">
                        </div>
                        {% endif %}
                        {{ form.cover_image }}
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Tags</label>
                        <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">
                            {% for choice in form.tags %}
                            <label for="{{ choice.id_for_label }}" class="flex items-center rounded-lg border border-border px-3 py-2 cursor-pointer hover:border-primary">
                                {{ choice.tag }}
                                <span class="ml-2 text-sm text-foreground">{{ choice.choice_label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <p class="mt-2 text-xs text-muted-foreground">
                            Don't see your tag? Create or edit tags from the Django admin panel.
                        </p>
                    </div>
                </section>

                <!-- Form Actions -->
                <div class="flex items-center justify-between pt-6 border-t border-border">
                    <a href="{% if book %}{% url 'book_detail' book.pk %}{% else %}{% url 'library' %}{% endif %}"
                       class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium tracking-wide transition-colors duration-200 border rounded-md bg-background text-foreground border-border hover:bg-accent hover:text-accent-foreground focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ring">
                        Cancel
                    </a>
                    <button type="submit" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium tracking-wide text-primary-foreground transition-colors duration-200 rounded-md bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        {{ action }} Book
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
